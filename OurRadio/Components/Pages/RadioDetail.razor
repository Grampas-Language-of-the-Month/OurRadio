@page "/radio/{id:int}"
@rendermode InteractiveServer
@using OurRadio.Models
@using OurRadio.Data
@using Microsoft.AspNetCore.SignalR.Client
@inject RadioService RadioService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>@radio?.Name</PageTitle>

@if (radio == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div>
        <h1>@radio.Name</h1>
        <p>@radio.Description</p>
        <a href="/radios" class="btn btn-secondary">Back to Radios</a>
    </div>

    <div class="mt-3">
        <strong>Now playing:</strong>
        @if (currentSong == null)
        {
            <span><em>Unknown</em></span>
        }
        else
        {
            <span>@currentSong.Title</span>
        }
    </div>

    <div class="my-3">
        <audio controls @ref="audioRef"></audio>
    </div>

    <div class="mb-3">
        <strong>Queue:</strong>
        @if (!isQueueLoaded)
        {
            <span><em>Loading...</em></span>
        }
        else if (queuedSongIds.Count == 0)
        {
            <span><em>No queued songs.</em></span>
        }
        else
        {
            <ol class="mt-2">
                @foreach (var queuedSong in GetQueuedSongs())
                {
                    <li>@queuedSong</li>
                }
            </ol>
        }
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Title</th>
                <th>Duration</th>
                <th>Filename</th>
                <th>Queue</th>
            </tr>
        </thead>
        <tbody>
            @if (songs == null)
            {
                <tr>
                    <td colspan="3"><em>Loading songs...</em></td>
                </tr>
            }
            else if (songs.Count == 0)
            {
                <tr>
                    <td colspan="3"><em>No songs found.</em></td>
                </tr>
            }
            else
            {
                @foreach (var song in songs)
                {
                    <tr>
                        <td>@song.Title</td>
                        <td>@secondsToDurationDisplay(song.DurationSeconds)</td>
                        <td>@song.Filename</td>
                        <td>
                            <button class="btn btn-outline-secondary btn-sm" @onclick="() => QueueSongAsync(song)">
                                Queue
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@code {
    [Parameter]
    public int Id { get; set; }

    private Radio? radio;

    private List<Song>? songs;

    private HubConnection? hubConnection;
    private ElementReference audioRef;
    private bool isRendered;
    private RadioPlaybackState? pendingState;
    private Song? currentSong;
    private List<int> queuedSongIds = new();
    private bool isQueueLoaded;

    protected override async Task OnInitializedAsync()
    {
        var radios = await RadioService.GetAllRadiosAsync();
        radio = radios.FirstOrDefault(r => r.Id == Id);

        if (radio == null)
        {
            NavigationManager.NavigateTo("/radios");
            return;
        }

        songs = await RadioService.GetSongsForRadioAsync(Id);

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/radio"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<RadioPlaybackState>("PlaybackState", async state =>
        {
            await ApplyStateAsync(state);
        });

        hubConnection.On<int[]>("QueueUpdated", queue =>
        {
            queuedSongIds = queue.ToList();
            isQueueLoaded = true;
            return InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();

        var state = await hubConnection.InvokeAsync<RadioPlaybackState?>("JoinRadio", Id);
        if (state != null)
        {
            await ApplyStateAsync(state);
        }

        var queue = await hubConnection.InvokeAsync<int[]>("GetQueue", Id);
        queuedSongIds = queue.ToList();
        isQueueLoaded = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        isRendered = true;

        if (pendingState != null)
        {
            var state = pendingState;
            pendingState = null;
            await ApplyStateAsync(state);
        }
    }

    private async Task ApplyStateAsync(RadioPlaybackState state)
    {
        if (!isRendered)
        {
            pendingState = state;
            return;
        }

        if (songs != null)
        {
            currentSong = songs.FirstOrDefault(song => song.Id == state.SongId);
        }

        await InvokeAsync(StateHasChanged);

        var src = $"/uploads/{state.Filename}";
        var elapsed = (DateTimeOffset.UtcNow - state.StartedAtUtc).TotalSeconds;
        if (elapsed < 0)
        {
            elapsed = 0;
        }

        await JS.InvokeVoidAsync("radioPlayer.setAndPlay", audioRef, src, elapsed);
    }

    private async Task QueueSongAsync(Song song)
    {
        if (hubConnection == null)
        {
            return;
        }

        await hubConnection.InvokeAsync("QueueSong", Id, song.Id);
    }

    private IEnumerable<string> GetQueuedSongs()
    {
        if (songs == null)
        {
            return queuedSongIds.Select(songId => $"Song {songId}");
        }

        var byId = songs.ToDictionary(song => song.Id, song => song.Title);
        return queuedSongIds.Select(songId => byId.TryGetValue(songId, out var title) ? title : $"Song {songId}");
    }

    private string secondsToDurationDisplay(int seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.Hours > 0)
        {
            return ts.ToString(@"h\:mm\:ss");
        }
        else
        {
            return ts.ToString(@"m\:ss");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            try
            {
                await hubConnection.InvokeAsync("LeaveRadio", Id);
            }
            catch
            {
            }

            await hubConnection.DisposeAsync();
        }
    }
}
