@page "/radios"
@rendermode InteractiveServer
@using OurRadio.Models
@using OurRadio.Data
@using Microsoft.AspNetCore.SignalR.Client
@inject RadioService RadioService
@inject SongService SongService
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@implements IAsyncDisposable

<PageTitle>Radios</PageTitle>

<h1>Radios</h1>

<button class="btn btn-primary mb-3" @onclick="ShowCreateForm">Create New Radio</button>

@if (isCreateModalOpen)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create Radio</h5>
                    <button type="button" class="btn-close" @onclick="CloseCreateForm" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <InputText class="form-control" @bind-Value="newRadio.Name" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <InputText class="form-control" @bind-Value="newRadio.Description" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CloseCreateForm">Cancel</button>
                    <button class="btn btn-primary" @onclick="SaveNewRadio" disabled="@isSaving">Save</button>
                </div>
            </div>
        </div>
    </div>
}

@if (radios == null)
{
    <p><em>Loading...</em></p>
}
else if (radios.Count == 0)
{
    <p><em>No radios found.</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Now Playing</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var radio in radios)
            {
                <tr>
                    <td>@radio.Name</td>
                    <td>@radio.Description</td>
                    <td>
                        @if (TryGetPlayback(radio.Id, out var state))
                        {
                            <div>@GetSongTitle(state.SongId)</div>
                            <div class="progress" style="height:6px;">
                                <div class="progress-bar" role="progressbar" style="width: @GetProgressPercent(state)%"></div>
                            </div>
                            <small class="text-muted">@GetProgressTime(state)</small>
                        }
                        else
                        {
                            <em>â€”</em>
                        }
                    </td>
                    <td>
                        <a href="@($"/radio/{radio.Id}")" class="btn btn-sm btn-primary">Visit</a>
                        <AuthorizeView>
                            <Authorized>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteRadio(radio.Id)">Delete</button>
                            </Authorized>
                            <NotAuthorized>
                                <button class="btn btn-sm btn-danger" disabled>Delete</button>
                            </NotAuthorized>
                        </AuthorizeView>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Radio>? radios;
    private bool isCreateModalOpen;
    private bool isSaving;
    private Radio newRadio = new();
    private HubConnection? hubConnection;
    private readonly Dictionary<int, RadioPlaybackState> playbackStates = new();
    private readonly Dictionary<int, string> songTitles = new();
    private Timer? uiTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadRadios();
        await EnsureHubConnectedAsync();
        await JoinRadiosAsync();
    }

    private async Task LoadRadios()
    {
        radios = await RadioService.GetAllRadiosAsync();
    }

    private async Task EnsureHubConnectedAsync()
    {
        if (hubConnection != null)
        {
            return;
        }

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/hubs/radio"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<RadioPlaybackState>("PlaybackState", state =>
        {
            playbackStates[state.RadioId] = state;
            _ = EnsureSongTitleAsync(state.SongId);
            _ = InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();

        uiTimer = new Timer(_ => _ = InvokeAsync(StateHasChanged), null, 1000, 1000);
    }

    private async Task JoinRadiosAsync()
    {
        if (hubConnection == null || radios == null)
        {
            return;
        }

        foreach (var radio in radios)
        {
            var state = await hubConnection.InvokeAsync<RadioPlaybackState?>("JoinRadio", radio.Id);
            if (state != null)
            {
                playbackStates[state.RadioId] = state;
                _ = EnsureSongTitleAsync(state.SongId);
            }
        }
    }

    private void ShowCreateForm()
    {
        newRadio = new Radio();
        isCreateModalOpen = true;
    }

    private void CloseCreateForm()
    {
        isCreateModalOpen = false;
    }

    private async Task SaveNewRadio()
    {
        if (string.IsNullOrWhiteSpace(newRadio.Name))
        {
            return;
        }

        isSaving = true;
        await RadioService.AddRadioAsync(newRadio);
        await LoadRadios();
        await JoinRadiosAsync();
        isSaving = false;
        isCreateModalOpen = false;
    }
    
    private async Task DeleteRadio(int id)
    {
        if (await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this radio?"))
        {
            await RadioService.DeleteRadioAsync(id);
            await LoadRadios();
            await JoinRadiosAsync();
        }
    }

    private bool TryGetPlayback(int radioId, out RadioPlaybackState state)
        => playbackStates.TryGetValue(radioId, out state!);

    private double GetProgressPercent(RadioPlaybackState state)
    {
        var elapsed = GetElapsedSeconds(state);
        if (state.DurationSeconds <= 0)
        {
            return 0;
        }

        var percent = (elapsed / state.DurationSeconds) * 100.0;
        if (percent < 0)
        {
            percent = 0;
        }

        if (percent > 100)
        {
            percent = 100;
        }

        return Math.Round(percent, 1);
    }

    private string GetProgressTime(RadioPlaybackState state)
    {
        var elapsed = GetElapsedSeconds(state);
        var total = state.DurationSeconds;
        return $"{FormatSeconds(elapsed)}/{FormatSeconds(total)}";
    }

    private double GetElapsedSeconds(RadioPlaybackState state)
    {
        var elapsed = (DateTimeOffset.UtcNow - state.StartedAtUtc).TotalSeconds;
        if (elapsed < 0)
        {
            elapsed = 0;
        }

        if (state.DurationSeconds > 0 && elapsed > state.DurationSeconds)
        {
            elapsed = state.DurationSeconds;
        }

        return elapsed;
    }

    private static string FormatSeconds(double seconds)
        => TimeSpan.FromSeconds(seconds).ToString(@"mm\:ss");

    private async Task EnsureSongTitleAsync(int songId)
    {
        if (songId <= 0 || songTitles.ContainsKey(songId))
        {
            return;
        }

        var song = await SongService.GetSongByIdAsync(songId);
        songTitles[songId] = song?.Title ?? $"Song {songId}";
        await InvokeAsync(StateHasChanged);
    }

    private string GetSongTitle(int songId)
        => songTitles.TryGetValue(songId, out var title) ? title : "Loading...";

    public async ValueTask DisposeAsync()
    {
        uiTimer?.Dispose();

        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}